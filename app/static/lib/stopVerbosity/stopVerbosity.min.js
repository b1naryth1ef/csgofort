/*
 *  Project: Stop Verbosity
 *  Description: Limits and counts the characters in a textarea.
 *  Author: William Huey
 *  License: MIT
 *  Version: 1.14.0
 *
 *  Credits:
 *  Tim Down (getInputSelection, setInputSelection)
 *    http://stackoverflow.com/questions/3549250/highlighting-a-piece-of-string-in-a-textarea
 *  Ben Alpert(isInputSupported)
 *    http://benalpert.com/2013/06/18/a-near-perfect-oninput-shim-for-ie-8-and-9.html
 *
 */

(function(e,t,n,r){"use strict";var i="stopVerbosity";var s=function(t,r){var s={limit:10,indicatorPosition:"after",indicatorId:"",indicatorElementType:"p",indicatorPhrase:["Used","[countup]","of","[limit]","characters.","[countdown]","characters remaining.","The maximum is","[limit]","characters.","<br>","Permits multiple counts up:","[countup]","and counts down:","[countdown].","This indicator is customizable."],indicatorUpdateSpeed:0,existingIndicator:"",generateIndicator:true,showIndicator:true,useNativeMaxlength:true,textLengthChange:false,useMaxlength:true,beforeAttachment:null,afterAttachment:null,existingText:"clear"};var o=function(t,n){o.element=t;o.options=e.extend({},s,n)};var u=o.prototype={init:function(){var n=e(t);var r=u.setupActions().init(n,o.options);u.eventsActions(n).init(o.options.limit,r)},setupActions:function(){var e=function(){};e.prototype={init:function(t,n){try{if(Object.prototype.toString.call(n.beforeAttachment)==="[object Function]"){n.beforeAttachment.call(t)}}catch(r){throw new TypeError("beforeAttachment is not a proper function.")}if(!Array.prototype.indexOf){Array.prototype.indexOf=function(e,t){if(this==null){throw new TypeError}var n=Object(this);var r=n.length>>>0;if(r===0){return-1}var i=0;if(arguments.length>1){i=Number(arguments[1]);if(i!=i){i=0}else if(i!=0&&i!=Infinity&&i!=-Infinity){i=(i>0||-1)*Math.floor(Math.abs(i))}}if(i>=r){return-1}var s=i>=0?i:Math.max(r-Math.abs(i),0);for(;s<r;s++){if(s in n&&n[s]===e){return s}}return-1}}var i=n.limit,s=n.indicatorPosition,o=n.indicatorId,u=n.indicatorElementType,a=n.indicatorPhrase,f=n.existingIndicator,l=n.generateIndicator,c=n.showIndicator,h=n.useNativeMaxlength,p=n.existingText;var d=e.prototype,v=d.setupDataStore;v.useNativeMaxlength=h;v.indicatorUpdateSpeed=n.indicatorUpdateSpeed;v.textLengthChange=n.textLengthChange;v.useMaxlength=n.useMaxlength;v.showIndicator=c;v.afterAttachment=n.afterAttachment;v.existingText=n.existingText;d.checkLimitOption(i);d.setIndicator(i,u,o,s,a,t,f,l,c,p);return d.setupDataStore},checkLimitOption:function(e){if(typeof e!=="number"){if(parseFloat(e)==parseInt(e,10)&&!isNaN(e)&&e>0){throw new RangeError("Text limit is not a valid positive integer.")}else{throw new TypeError("Specified text limit is not a number.")}}},setIndicator:function(e,t,n,r,i,s,o,u,a,f){function c(t,n,r){for(var i=0,s=t.length;i<s;i++){var o=t[i],u=o.length,a="["+o+"]",f="\\["+o+"\\]",l=o+"Coupled",c=0,h=n.length,p=new RegExp(f);l=r.setupDataStore[l]={};for(;c<h;c++){var d=n[c];if(d===a){r.setupDataStore[o].push(c)}else if(p.test(d)){var v=d.indexOf(a),m=[];m.push(v);while(v>-1){v=d.indexOf(a,v+1);if(v>-1){m.push(v)}}if(m.length===1){var g=l[c]={};var y=p.exec(d).index;var b=d.slice(0,y),w=y+u+2,E=d.length,S=d.slice(w,E);switch(o){case"limit":case"countdown":n[c]=b+e+S;break;case"countup":n[c]=b+"0"+S;break}var x=E-w;g.firstEnd=y;g.backDifference=x}}}}}function h(e,t,n,r){for(var i=0,s=e.length;i<s;i++){var o=e[i],u=r.setupDataStore[o],a=u.length,f=0;for(;f<a;f++){var l=u[f];switch(o){case"countup":n[l]=0;break;default:t.phrase[l]=t.limit;break}}}}if(!a){return}var l=this;c(["limit","countup","countdown"],i,l);var p={phrase:i,limit:e};h(["limit","countdown","countup"],p,i,l);this.setupDataStore.indicatorPhrase=i;if(Object.prototype.toString.call(o)==="[object Object]"){try{if(o instanceof jQuery){this.setupDataStore.indicatorElement=o;o.html(i.join(" "));u=false}}catch(d){throw new TypeError("Not a jQuery Object.")}}if(u){var v=n.length>0?" id="+n:"";var m=["<",t,v,">",i.join(" "),"</",t,">"].join(""),g=["Not a valid position for indicator,","only accepts ","'before'"," or ","'after'"].join("");if(r==="after"){s.after(m);this.setupDataStore.indicatorElement=s.next()}else if(r==="before"){s.before(m);this.setupDataStore.indicatorElement=s.prev()}else{throw new Error(g)}}},setupDataStore:{limit:[],countup:[],countdown:[]}};return e.prototype},eventsActions:function(t){var r=function(){},s=r.prototype={init:function(e,t){s.addListeners(e,t)},addListeners:function(e,r){var u=this.dataStore;u.limit=e;u.indicator=r;var a=r.indicatorUpdateSpeed;var f=r.existingText;var l={preventFunction:function(){if(u.eventPrevent===null&&!u.isTextSelected){s.setDataStore("eventPrevent","keydown");s.removeDataStore("eventPresent");t.off("keydown."+i);s.keydownFunction.keydownPrevent();s.pastePreventFunction()}},allowFunction:function(){if(u.eventPrevent!==null){s.removeDataStore("eventPrevent");s.setDataStore("eventPresent","keydown");t.off("keydown."+i).off("paste."+i);s.keydownFunction.keydown()}},changeText:function(t){var n=u.indicator,r=0,i=t.length;for(;r<i;r++){var o=t[r],f=n[o];if(typeof f!=="undefined"){var l=Object.prototype.toString.call(f);if(l==="[object Object]"){for(var c in f){if(f.hasOwnProperty(c)){var h=n.indicatorPhrase[c],p=h.length,d=f[c];var v=h.slice(0,d.firstEnd),m=p-d.backDifference,g=d.backDifference+p,y=h.slice(m,g);var b;if(o==="countdownCoupled"){w=e-s.getTextAreaLength();b=v+w+y}else if(o==="countupCoupled"){w=s.getTextAreaLength();b=v+w+y}n.indicatorPhrase[c]=b}}}else if(l==="[object Array]"){var w;if(o==="countdown"){w=e-s.getTextAreaLength()}else if(o==="countup"){w=s.getTextAreaLength()}var E=n[o],S=E.length,x=0;for(;x<S;x++){n.indicatorPhrase[E[x]]=w}}}}if(a>0){setTimeout(function(){n.indicatorElement.html(n.indicatorPhrase.join(" "))},a)}else{n.indicatorElement.html(n.indicatorPhrase.join(" "))}},textLengthChange:function(n){if(r.textLengthChange){var i=s.getTextAreaLength();if(i!==n){c.currentTextLength=i;c.lastTextLength=n;if(i<e){c.isLimitReached=false;c.exceededLimit=false}else if(i===e){c.isLimitReached=true;c.exceededLimit=false}else if(i>e){c.isLimitReached=true;c.exceededLimit=true}t.trigger("sv-textLengthChange",c)}}}};var c=l.textLengthChange.obj={};c.element=o.element;if(u.indicator.indicatorElement){c.indicatorElement=u.indicator.indicatorElement}var h=n.createElement("textarea"),p;if("oninput"in h){u.partialInputSupport=true;if(!("documentMode"in n)||n.documentMode>9){p=false;u.supportsInput=true;u.partialInputSupport=false}}else if("onpropertychange"in h){p=true;u.supportsInput=false}u.checkFirstKeyDown=p;if(!!("maxLength"in h)){if(r.useNativeMaxlength&&r.useMaxlength){t.attr("maxlength",e)}}s.setInputSelection.offsetToRangeCharacterMove=function(e,t){return t-(e.value.slice(0,t).split("\r\n").length-1)};s.deselectFunction(l);s.selectFunction(l);s.dropFunction();s.inputFunction(l);s.trackSelectionEventsFunction();s.mousedownFunction();s.clickFunction();s.keydownFunction();if(f==="clear"){t.val("")}else if(f==="truncate"){if(t.val().length>0){t.trigger("propertychange."+i)}}else{throw new Error('Must be string value of "clear" or "truncate".')}try{if(Object.prototype.toString.call(r.afterAttachment)==="[object Function]"){r.afterAttachment.call(t,c)}}catch(d){throw new TypeError("afterAttachment is not a proper function.")}},inputFunction:function(r){var o=s.dataStore,u=["countdown","countup","countdownCoupled","countupCoupled"],a={};var f=function(){if(o.indicator.showIndicator){r.changeText(u);s.copyObjectValue(o,a,"lengthText");s.setDataStore("lengthText",s.getTextAreaLength());r.textLengthChange(a.lengthText)}else{s.setDataStore("lengthText",s.getTextAreaLength())}};t.on("input."+i+" "+"propertychange."+i,function(){o.checkFirstKeyDown=false;if(s.dataStore.dropOccurred){s.dataStore.dropOccurred=false;return}var e=o.limit,n=s.checkLimit(e);s.setDataStore("textStatus",n);if(n==="less"){if(o.falsePositive){r.allowFunction()}f();setTimeout(function(){s.trackSelectionFunction()})}else if(n==="equal"){if(o.falsePositive){if(o.indicator.useMaxlength){r.preventFunction()}}f();setTimeout(function(){s.trackSelectionFunction();if(o.falsePositive){if(typeof s.dataStore.newCaretPos==="number"){var e=s.dataStore.newCaretPos;s.setInputSelection(e,e);s.dataStore.newCaretPos=null}}})}else if(n==="greater"){o.falsePositive=true;if(o.selectBeforeKeydown){o.caretStatus=o.selectCaretStatus}if(o.indicator.useMaxlength){var u=s.getTextAreaLength(),a=o.caretStatus,l=a.start,c=a.end,h=o.lengthText,p=e-h,d=s.getText();var v,m,g,y;if(o.isTextSelected||o.selectBeforeKeydown){v=a.end;g=a.end;y=p+c;m=u-(h-c)}else{v=l;g=l;y=p+l;m=u-(h-l)}var b=d.slice(0,v),w=d.slice(g,y),E=d.slice(m,u),S=b+w+E,x=b.length+w.length;o.newCaretPos=x;if(S.length<=e){t.val(S);t.trigger("propertychange."+i)}}else{f()}}});if(o.partialInputSupport){e(n).on("selectionchange."+i,function(){if(s.getTextAreaLength()<o.lengthText){t.trigger("propertychange."+i)}})}},dropFunction:function(){var e=s.dataStore;t.on("drop."+i,function(){s.dataStore.dropOccurred=true;setTimeout(function(){s.trackSelectionFunction();var n=e.caretStatus,r=n.start,o=n.end,u;if(r!==o){e.caretStatus.start=r;e.caretStatus.end=r;u=o}else{var a=e.lengthText,f=t.val().length-a,l=r-f;e.caretStatus.start=l;e.caretStatus.end=l;u=r}s.setInputSelection(u,u);s.dataStore.dropOccurred=false;t.trigger("input."+i)})})},pastePreventFunction:function(){t.on("paste."+i,function(e){s.negateEvent(e)})},deselectFunction:function(e){t.on("stopVerbosity-deselect",function(){var n=s.dataStore.limit,r=s.checkLimit(n);s.trackSelectionFunction();if(r==="equal"){if(s.dataStore.indicator.useMaxlength){e.preventFunction()}}else if(r==="greater"){t.trigger("propertychange."+i)}})},selectFunction:function(e){t.on("select."+i,function(){if(s.dataStore.dropOccurred){return}s.trackSelectionFunction();var t=s.dataStore.caretStatus,n=s.dataStore.limit,r=s.checkLimit(n);var i=t.start,o=t.end,u=s.dataStore.selectCaretStatus;u.start=i;u.end=o;if(r==="equal"){if(t.end===t.start){if(s.dataStore.indicator.useMaxlength){e.preventFunction()}}else{e.allowFunction()}}})},trackSelectionEventsFunction:function(){var e=["mouseout","focus","blur","keyup"],n=s.appendNameSpace(e,i);t.on(n,function(){setTimeout(function(){s.trackSelectionFunction()})})},appendNameSpace:function(e,t){var n=e.length,r=0;for(;r<n;r++){e[r]=e[r]+"."+t}},mousedownFunction:function(){t.on("mousedown."+i,function(){s.setDataStore("isMouseDown",true)})},clickFunction:function(){t.on("click."+i,function(){setTimeout(function(){s.trackSelectionFunction()});s.setDataStore("isMouseDown",false)})},keydownFunction:function(){var e=s.dataStore;this.keydownFunction.checkFirstKeyDown=function(n){if(e.checkFirstKeyDown){if(e.continueKeyCheck){setTimeout(function(){if(s.getTextAreaLength()>0){t.trigger("propertychange."+i)}})}}if(n==="keyprevent"){setTimeout(function(){t.trigger("propertychange."+i)})}};this.keydownFunction.checkTab=function(e){if(e.which===9){if(s.dataStore.isMouseDown){s.negateEvent(e);return true}}};this.keydownFunction.keydownPrevent=function(){t.on("keydown."+i,function(t){switch(t.which){case 0:case 8:case 9:case 16:case 17:case 18:case 19:case 20:case 27:case 33:case 34:case 35:case 36:case 37:case 38:case 39:case 40:case 45:case 46:case 112:case 113:case 114:case 115:case 116:case 117:case 118:case 119:case 120:case 121:case 122:case 123:s.keydownFunction.checkTab(t);s.keydownFunction.checkFirstKeyDown("keyprevent");e.falsePositive=true;break;default:if(t.ctrlKey===false){t.preventDefault()}break}setTimeout(function(){s.trackSelectionFunction();if(s.dataStore.isTextSelected){s.dataStore.selectBeforeKeydown=true}else{s.dataStore.selectBeforeKeydown=false}})})};t.off("keydown."+i);this.keydownFunction.keydown=function(){t.on("keydown."+i,function(e){s.keydownFunction.checkTab(e);s.keydownFunction.checkFirstKeyDown();setTimeout(function(){s.trackSelectionFunction();if(s.dataStore.isTextSelected){s.dataStore.selectBeforeKeydown=true}else{s.dataStore.selectBeforeKeydown=false}})})};this.keydownFunction.keydown()},dataStore:{newCaretPos:null,caretStatus:{start:0,end:0},selectCaretStatus:{start:0,end:0},dropOccurred:false,isMouseDown:false,isTextSelected:false,isLimitReached:false,textStatus:null,lengthText:0,keyDownPresent:false,click:false,eventPresent:"keydown",eventPrevent:null,falsePositive:false,checkFirstKeyDown:false,continueKeyCheck:true,selectBeforeKeydown:false,supportsInput:null},removeDataStore:function(e){this.dataStore[e]=null},setDataStore:function(e,t){this.dataStore[e]=t},copyObjectValue:function(e,t,n){for(var r in e){if(e.hasOwnProperty(r)){if(n===r){t[n]=e[n]}}}},negateEvent:function(e){e.preventDefault();e.stopPropagation()},isTextSelected:function(e){if(Math.abs(e.start-e.end)>0){return true}},setSelectionStatus:function(){var e=this.dataStore;e.caretStatus=s.getInputSelection();if(s.isTextSelected(e.caretStatus)){this.setDataStore("isTextSelected",true)}else{this.setDataStore("isTextSelected",false)}},trackSelectionFunction:function(){var e=s.dataStore.isTextSelected;s.setSelectionStatus();var n=s.dataStore.isTextSelected;if(e&&n===false){t.trigger("stopVerbosity-deselect")}},getText:function(){return t.val()},getTextAreaLength:function(){return this.getText().length},checkLimit:function(e){var t=this.getTextAreaLength();if(t>e){return"greater"}else if(t===e){return"equal"}else if(t<e){return"less"}},setInputSelection:function(e,n){var r=this.setInputSelection;var i=t[0];if(typeof i.selectionStart==="number"&&typeof i.selectionEnd==="number"){i.selectionStart=e;i.selectionEnd=n}else{var s=i.createTextRange();var o=r.offsetToRangeCharacterMove(i,e);s.collapse(true);if(e===n){s.move("character",o)}else{s.moveEnd("character",r.offsetToRangeCharacterMove(i,n));s.moveStart("character",o)}s.select()}},getInputSelection:function(){var e=0,r=0,i,s,o,u,a,f=t[0];if(typeof f.selectionStart==="number"&&typeof f.selectionEnd==="number"){e=f.selectionStart;r=f.selectionEnd}else{s=n.selection.createRange();if(s&&s.parentElement()===f){u=f.value.length;i=f.value.replace(/\r\n/g,"\n");o=f.createTextRange();o.moveToBookmark(s.getBookmark());a=f.createTextRange();a.collapse(false);if(o.compareEndPoints("StartToEnd",a)>-1){e=r=u}else{e=-o.moveStart("character",-u);e+=i.slice(0,e).split("\n").length-1;if(o.compareEndPoints("EndToEnd",a)>-1){r=u}else{r=-o.moveEnd("character",-u);r+=i.slice(0,r).split("\n").length-1}}}}return{start:e,end:r}}};return r.prototype}};o(t,r);o.prototype.init()};e.fn[i]=function(t){return this.each(function(){if(!e.data(this,"plugin_"+i)){e.data(this,"plugin_"+i,new s(this,t))}})}})(jQuery,window,document)